<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta htpp-equiv="Content-language" content="fr" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/style.css"/>
    <title>ERP Machine Sight</title>
</head>
<body>
    <span id="menu" onclick="openNav()">Menu</span>
    <h1> ERP </h1>
    <h2> Liste Nomenclatures </h2>
    
    <div id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
        <a class ="bouton" href="/fournisseurs">Liste fournisseurs</a>
        <a class ="bouton" href="/bonCommande">Liste bons commande</a>
        <a class ="bouton" href="/projet">Liste projets</a>
        <a class= "bouton" href="/client"> Liste clients</a>
        <a class ="bouton" href="/connection">Connection</a>
    </div>

    <a class ="bouton" href="/nomenclature/resetPanier" onclick="deselectAll()">Reset panier BDC </a>
    <a class ="bouton" href="/nomenclature/inter/commandePDF" > Génèrer BDC </a> 
    <a class ="bouton" href="javascript:void(0)" onclick="selectAll()">Select all</a>
    <a class ="bouton" href="/nomenclature/modifAllForm">Modifier all</a>
    <a class="bouton" href="/nomenclature/majPrixTotal">MAJ prix total</a>
    <a class="bouton" href="/nomenclature/ajoutNomenclature">Add NMCLTRE</a>

    <label for="selectionRecherche">Choisir filtre </label>
    <select name="selectionRecherche" id="selectionRecherche">
        <label>Choissir colonne de filtre</label>
        <option value="1">idNomenclature</option>
        <option value="2">idPiece</option>
        <option value="3">denomination</option>
        <option value="4">rev</option>
        <option value="8">matiere</option>
        <option value="14">fournisseur</option>
        <option value="15">refDescriptionFournisseur</option>
        <option value="18">idBonCommande</option>
        <option value="20">nomProjet</option>
        <option value="21">client</option>
        <option value="22">idFournisseur</option>
        <option value="30">refCommande</option>
        <option value="32">par</option>
        <option value="33">spare parts</option>
    </select>
    <input type="text" id="myInput" onkeyup="filterFunction()" placeholder="Search for..">
    
    <label for="selectionRecherche2">Choisir filtre 2 </label>
    <select name="selectionRecherche2" id="selectionRecherche2">
        <label>Choissir colonne de filtre</label>
        <option value="1">idNomenclature</option>
        <option value="2">idPiece</option>
        <option value="3">denomination</option>
        <option value="4">rev</option>
        <option value="8">matiere</option>
        <option value="14">fournisseur</option>
        <option value="15">refDescriptionFournisseur</option>
        <option value="18">idBonCommande</option>
        <option value="20">nomProjet</option>
        <option value="21">client</option>
        <option value="22">idFournisseur</option>
        <option value="30">refCommande</option>
        <option value="32">par</option>
        <option value="33">spare parts</option>
    </select>
    <input type="text" id="myInput2" onkeyup="filterFunction2()" placeholder="Search for..">

    <form action="/upload" enctype="multipart/form-data" method="post">
        <label style="font-weight:bold;">Upload nomenclature</label>
        <input type="file" name="fileUpload" >
        <input type="submit">
    </form>  

    <div id="reaffiche"></div>

    <table id="myTable">
            <tr class="header">
                <th>Ajout bon commande</th>
                <th>idNomenclature</th>
                <th>idPiece</th>
                <th>denomination</th>
                <th>idProjet</th>
                <th>rev</th>
                <th>qte</th>
                <th>unite</th>
                <th>matiere</th>
                <th>brut</th>
                <th>realisation</th>
                <th>finition</th>
                <th>traitementDeSurface</th>
                <th>planEdite</th>
                <th>fournisseur</th>
                <th>refFournisseur</th>
                <th>dateLivraisonPrevue</th>
                <th>statut</th>
                <th>bonDeCommande</th>
                <th>commentaire</th>                
                <th>nomProjet</th>
                <th>client</th>
                <th>idFournisseur</th>                
                <th>prixUnitMS</th>
                <th>prixUnitClient</th>
                <th>remise</th>
                <th>prixNetTotal</th>
                <th>marge</th>
                <th>prixTotalClient</th>
                <th>effectue</th>
                <th>refCommande</th>
                <th>montantDepense</th>
                <th>par</th>
                <th>spare parts</th>
            </tr>
            <% for (var i=0; i<nomenclature.length; i++){ %>
            <tr>
                    <td>
                        <a class="bouton" href="/nomenclature/<%=nomenclature[i].idNomenclature %>">Ajout bon commande</a>
                    </td>
                    <td id="idNomenclature<%=i%>" name="idNomenclature"> 
                        <%=nomenclature[i].idNomenclature%> 
                    </td> 
                    <td id="<%=i%>" class="idPiece">
                        <%=nomenclature[i].idPiece %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="denomination">
                        <%=nomenclature[i].denomination %> 
                    </td>
                    <td id="<%=i%>" class="idProjet">
                        <%=nomenclature[i].idProjet %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="rev" >
                        <%=nomenclature[i].rev %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="qte">
                        <%=nomenclature[i].qte %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="unite">
                        <%=nomenclature[i].unite %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="matiere">
                        <%=nomenclature[i].matiere %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="brut">
                        <%=nomenclature[i].brut %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="realisation">
                        <%=nomenclature[i].realisation %> 
                    </td>
                    <td  contenteditable='true' id="<%=i%>" class="finition">
                        <%=nomenclature[i].finition %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="traitementDeSurface">
                        <%=nomenclature[i].traitementDeSurface %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="planEdite">
                        <%=nomenclature[i].planEdite %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="fournisseur">
                        <%=nomenclature[i].fournisseur %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="refFournisseur">
                        <%=nomenclature[i].refFournisseur %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="livraisonPrevue">
                        <%=nomenclature[i].livraisonPrevue %> 
                    </td>
                    <td>    
                        <select name="<%=nomenclature[i].statut%>" class="statut" id="<%=i%>" onchange="changeStatut(this, <%=i%>)">
                            <option></option>
                            <option id="prevu<%=i%>"> prevu</option>
                            <option id="recept<%=i%>"> recept</option>
                        </select>
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="idBonCommande">
                        <%=nomenclature[i].idBonCommande %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="commentaire">
                        <%=nomenclature[i].commentaire %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="nomProjet">
                        <%=nomenclature[i].nomProjet %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="client">
                        <%=nomenclature[i].client %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="idFournisseur">
                        <%=nomenclature[i].idFournisseur %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="prixUnitMs">
                        <%=nomenclature[i].prixUnitMs %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="prixUnitClient">
                        <%=nomenclature[i].prixUnitClient %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="remise">
                        <%=nomenclature[i].remise %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="prixNetTotal">
                        <%=nomenclature[i].PrixNetTotal %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="marge">
                        <%=nomenclature[i].marge %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="prixTotalClient">
                        <%=nomenclature[i].prixTotalClient %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="effectue" >
                        <%=nomenclature[i].effectue %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="refCommande" >
                        <%=nomenclature[i].refCommande%> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="montantDepense" >
                        <%=nomenclature[i].montantDepense %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="par" >
                        <%=nomenclature[i].par %> 
                    </td>
                    <td>
                        <input type="checkbox" name="<%=nomenclature[i].spareParts%>" class="spareParts" id="spareParts<%=i%>" onchange="changeSpareParts(this, <%=i%>)" value="checked" >
                    </td>
            </tr>
            <% } %> 
    </table>

    <script>
        function openNav() {
            //Pour menu navigation
            document.getElementById("mySidenav").style.width = "250px";
            document.getElementById("main").style.marginLeft = "250px";
            document.body.style.backgroundColor = "rgba(0,0,0,0.4)";
        }
        function closeNav() {
            document.getElementById("mySidenav").style.width = "0";
            document.getElementById("main").style.marginLeft = "0";
            document.body.style.backgroundColor = "white";
        }

        window.onload = function() {
            let statut = document.getElementsByClassName("statut");
            let spareParts = document.getElementsByClassName("spareParts");
            //Gere la couleur de statut / DEUXIEME FOR  
            let livraisonPrevue = document.getElementsByClassName("livraisonPrevue");
            let dateLivraison = [];
            let date = new Date();
            
            //Deplace le selected pour natureProjet de options sur données BDD 
            for (var i=0; i<statut.length; i++){
                let name = statut[i].getAttribute("name");
                let myID = statut[i].getAttribute("id");
                let mySelected;  
                switch (name) {
                    case "prevu": 
                        mySelected = document.getElementById("prevu"+myID);
                        mySelected.selected = true
                        break;
                    case "recept":
                        mySelected = document.getElementById("recept"+myID);
                        mySelected.selected = true
                        break;
                    default:
                        console.log("Pas la bonne valeur statut");
                }
            }
            //Deplace le checked pour spareParts sur données BDD 
            for (var i=0; i<spareParts.length; i++){
                let nameSpareParts = spareParts[i].getAttribute("name")
                let idSpareParts = spareParts[i].getAttribute("id")
                let myChecked;
                switch (nameSpareParts) {
                    case "checked":
                        myChecked = document.getElementById(idSpareParts);
                        myChecked.checked=true;
                        break;
                    default:
                }
            }
            for (var i=0; i<livraisonPrevue.length;i++){
                dateLivraison.push(new Date(Date.parse(livraisonPrevue[i].innerHTML.trim())));   
                if (dateLivraison[i]!='Invalid Date' && statut[i].getAttribute("name")!="recept"){
                    if (date<=dateLivraison[i]){
                        statut[i].style.backgroundColor="orange";                        
                    } else {
                        statut[i].style.backgroundColor="red";
                    }
                }else if (statut[i].getAttribute("name")=="recept") {
                    statut[i].style.backgroundColor="lightgreen";                        
                }
            }
        }

        function selectAll() {
            //Selectioner tout les id et les renvoyer au controller
            let idNomenclatures = [];
            if (document.readyState !== 'loading') {
            // Attendre que elements soient chargé
                table = document.getElementById("myTable");
                tr = table.getElementsByTagName("tr");
                for (var i=1; i<tr.length; i++){
                    //Parcourir tag tr et boucle condit sur if
                    let elem = 0;
                    if (tr[i].style.display=="") {
                        elem = document.getElementById("idNomenclature"+ (i - 1));
                        tr[i].style.backgroundColor="lightskyblue";
                        idNomenclatures.push(elem.innerHTML.trim());
                    }
                }
                const data = {idNomenclatures};
                const options = {
                    method: 'POST',
                    headers: {
                    'Content-Type':'application/json'
                    },
                body: JSON.stringify(data)
                };
                fetch('./nomenclature/selectAll', options);
            }
        }

        function deselectAll() {
            table = document.getElementById("myTable");
            tr = table.getElementsByTagName("tr");
            for (var i=1; i<tr.length; i++){
                //Parcourir tag tr et boucle condit sur if
                if (tr[i].style.display=="") {
                    tr[i].style.backgroundColor="";
                }
            }
        }

        function filterFunction() {
            // fonction filtre-recherche
            var input, filter, table, tr, td, i, txtValue;
            input = document.getElementById("myInput");
            filter = input.value.toUpperCase();
            table = document.getElementById("myTable");
            tr = table.getElementsByTagName("tr");
            a = document.getElementById("selectionRecherche").value;
            if (a==33){
                //spare parts, checkbox: chiant avec value
                let test = document.getElementsByClassName("spareParts");
                for (var j=0; j<test.length; j++){
                    if (test[j].name=="checked"){
                        tr[j].style.display = "";
                    } else {
                        tr[j].style.display = "none";
                    }
                }
            }else {
                // Loop tr
                for (i = 0; i < tr.length; i++) {
                    td = tr[i].getElementsByTagName("td")[a];
                    if (td) {
                        txtValue = td.textContent || td.innerText;
                        if (txtValue.toUpperCase().indexOf(filter) > -1) {
                            tr[i].style.display = "";
                        } else {
                            tr[i].style.display = "none";
                        }
                    }
                }
            }
        }

        function filterFunction2() {
            // fonction filtre-recherche
            var input, filter, table, tr, td, i, txtValue;
            input = document.getElementById("myInput2");
            filter = input.value.toUpperCase();
            table = document.getElementById("myTable");
            tr = table.getElementsByTagName("tr");
            a = document.getElementById("selectionRecherche2").value;
            if (a==33){
                //spare parts, checkbox: chiant avec value
                let test = document.getElementsByClassName("spareParts");
                for (var j=0; j<test.length; j++){
                    if (test[j].name=="checked"){
                        tr[j].style.display = "";
                    } else {
                        tr[j].style.display = "none";
                    }
                }
            }else {
                // Loop tr
                for (i = 0; i < tr.length; i++) {
                    td = tr[i].getElementsByTagName("td")[a];
                    if (td) {
                        txtValue = td.textContent || td.innerText;
                        if (txtValue.toUpperCase().indexOf(filter) > -1) {
                            tr[i].style.display = "";
                        } else {
                            tr[i].style.display = "none";
                        }
                    }
                }
            }
        }

        //Pour trigger modification et envoyer avec post method
        var all = document.getElementsByTagName("td");
        for (var j=0; j<all.length;j++){
            all[j].addEventListener("input", function(e) {
                const newData = this.innerHTML;
                let stringID = 'idNomenclature' + this.id;
                const myID = document.getElementById(stringID).innerHTML;
                const myColumn = this.className;
                const data = {newData, myID, myColumn};
                const options = {
                    method: 'POST',
                    headers: {
                    'Content-Type':'application/json'
                    },
                body: JSON.stringify(data)
                };
                fetch('./nomenclature/inter/modification', options);
                e.stopPropagation();
            }, false);       
        }

        function changeStatut(selectObject, id){
            const newData = selectObject.value;  
            let stringID = 'idNomenclature' + id;
            const myID = document.getElementById(stringID).innerHTML;
            const myColumn = "statut";
            const data = {newData, myID, myColumn};
                const options = {
                    method: 'POST',
                    headers: {
                    'Content-Type':'application/json'
                    },
                body: JSON.stringify(data)
                };
                fetch('./nomenclature/inter/modification', options);
        }

        function checkBoxData(newValue, oldValue, id){
            //Checkbox n'a qu'une seule valeur de retour (check ou uncheck)
            let elemSpareParts = document.getElementById("spareParts"+id);
            if (newValue==oldValue){
                elemSpareParts.name = "";
                return ""
            } else {
                elemSpareParts.name = "checked";
                return "checked"
            }
        }

        function changeSpareParts(selectObject, id){
            let stringID = 'idNomenclature' + id;
            const myID = document.getElementById(stringID).innerHTML;
            const newData = checkBoxData(selectObject.value, selectObject.name, id); 
            const myColumn = "spareParts";
            const data = {newData, myID, myColumn};
            const options = {
                method: 'POST',
                headers: {
                'Content-Type':'application/json'
                },
            body: JSON.stringify(data)
            };
            fetch('./nomenclature/inter/modification', options);
        }

        //Pour affichage ou pas des colonnes visible
        var delC =null, oTh =  null;
        document.addEventListener('DOMContentLoaded',function(){
            //reperage click
            oTable = document.getElementById('myTable');
            oTh = oTable.getElementsByTagName('th');
            for(var i = 0; i<oTh.length; i++){
                oTh[i].addEventListener('click',  supprimerColonne);
            }
        });
        
        function supprimerColonne(oEvent){
            var sClassHide = 'cel-hide',oEle = oEvent.currentTarget,
                oTable = oEle.parentNode.parentNode.parentNode,
                iIndex = oEle.cellIndex,
                oTd = oTable.querySelectorAll('td:nth-child('+(iIndex+1)+')'), 
                iNbTd = oTd.length;
            for(var i = 0; i< iNbTd; i++){
                oTd[i].classList.add(sClassHide);
            }
            oEle.classList.add(sClassHide);
            addAfficher(iIndex);
        }
        
        function names(iIndex){
            let res;
            switch(iIndex){
                case 1:
                    res = 'idNomenclature'
                    break;
                case 2:
                    res = "idPiece";
                    break;
                case 3:
                    res = "denomination";
                    break;
                case 4:
                    res = "idProjet";
                    break;
                case 5:
                    res = "rev";
                    break;
                case 6:
                    res = "qte";
                    break;
                case 7:
                    res = "unite";
                    break;
                case 8:
                    res = "matiere";
                    break;
                case 9:
                    res = "brut";
                    break;
                case 10:
                    res = "realisation";
                    break;
                case 11:
                    res = "finition";
                    break;
                case 12:
                    res = "traitement de surface";
                    break;
                case 13:
                    res = "plan edite";
                    break;
                case 14:
                    res = "fournisseur";
                    break;
                case 15:
                    res = "ref fournisseur";
                    break;
                case 16:
                    res = "livraison prevu";
                    break;
                case 17:
                    res = "statut";
                    break;
                case 18:
                    res = "idBonCommande";
                    break;
                default:
                    res = iIndex;
            }
            return res;
        }

        function addAfficher(iIndex){
            var oBloc = document.getElementById("reaffiche");
            let cellName = names(iIndex);
            oBloc.innerHTML += '<a href="javascript:reAfficher('+iIndex+')" id="col-'+iIndex+'">Réaffiche colonne '+cellName+'</a><br>';
        }
        
        function reAfficher(iIndex){
            document.getElementById("col-"+iIndex).remove();
            var sClassHide = 'cel-hide',
                oTable = document.getElementById("myTable"),
                oTd = oTable.querySelectorAll('td:nth-child('+(iIndex+1)+')'), 
                iNbTd = oTd.length;
            for(var i = 0; i< iNbTd; i++){
                oTd[i].classList.remove(sClassHide);
            }
            oTable.querySelector('th:nth-child('+(iIndex+1)+')').classList.remove(sClassHide);
        }
        </script>
</body>
</html>