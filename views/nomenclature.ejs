<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/style.css"/>
    <title>ERP Machine Sight</title>
</head>
<body>
    <h1> ERP </h1>
    <h2> Liste Nomenclatures </h2>
    
    <a class ="bouton" href="/nomenclature/fournisseur">Liste fournisseurs</a>
    <!-- <a class ="bouton" href="/nomenclature/article">Liste articles</a> -->
    <a class ="bouton" href="/nomenclature/bonCommande">Liste bons commande</a>
    <a class ="bouton" href="/nomenclature/projet">Liste projets</a>
    <a class ="bouton" href="/nomenclature/resetPanier">Reset panier bon </a>
    <a class ="bouton" href="/nomenclature/inter/commandePDF"> Génère PDF bon </a>
    <a class ="bouton" onclick= ajoutePDF() >Ajoute ref bon</a>
    <label for="reference">Reference :</label> <input id="reference" type="text" name="reference" placeholder="Inserer reference bon commande" />

    <label for="selectionRecherche">Choisir filtre </label>
    <select name="selectionRecherche" id="selectionRecherche">
        <label>Choissir colonne de filtre</label>
        <option value="1">idPiece</option>
        <option value="2">denomination</option>
        <option value="3">n_piece_plan</option>
        <option value="4">rev</option>
        <option value="7">matiere</option>
        <option value="13">fournisseur</option>
        <option value="14">refDescriptionFournisseur</option>
        <option value="20">prixtotalclient</option>
        <option value="22">statut</option>
        <option value="25">numProjet</option>
        <option value="26">nomProjet</option>
        <option value="27">client</option>
    </select>
    <input type="text" id="myInput" onkeyup="myFunction()" placeholder="Search for..">

    <form action="/upload-avatar" enctype="multipart/form-data" method="post">
        <label style="font-weight:bold;">Upload nomenclature</label>
        <input type="file" name="fileUpload" >
        <input type="submit">
    </form>  

    <div id="reaffiche"></div>

    <table id="myTable">
            <tr class="header">
                <th>Ajout bon commande</th>
                <th>idPiece</th>
                <th>denomination</th>
                <th>n_piece_plan</th>
                <th>rev</th>
                <th>qte</th>
                <th>unite</th>
                <th>matiere</th>
                <th>brut</th>
                <th>realisation</th>
                <th>finition</th>
                <th>traitementDeSurface</th>
                <th>planEdite</th>
                <th>fournisseur</th>
                <th>refDescriptionFournisseur</th>
                <th>prixnetUnitaireMS</th>
                <th>remise</th>
                <th>prixNetTotal</th>
                <th>marge</th>
                <th>prixunitclient</th>
                <th>prixtotalclient</th>
                <th>datedelivraisonprevue</th>
                <th>statut</th>
                <th>bonDeCommande</th>
                <th>commentaire</th>
                <th>numProjet</th>
                <th>nomProjet</th>
                <th>client</th>
                <th>idFournisseur</th>
                <th>idNomenclature</th>
            </tr>
            <% for (var i=0; i<nomenclature.length; i++){ %>
            <tr>
                    <td>
                        <a class="bouton" href="/nomenclature/<%= nomenclature[i].idPiece %> ">Ajout bon commande</a>
                    </td>
                    <td id="idPiece<%=i%>" name="idPiece">
                        <%=nomenclature[i].idPiece %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="denomination" >
                        <%=nomenclature[i].denomination %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="n_piece_plan">
                        <%=nomenclature[i].n_piece_plan %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="rev" >
                        <%=nomenclature[i].rev %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="qte">
                        <%=nomenclature[i].qte %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="unite">
                        <%=nomenclature[i].unite %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="matiere">
                        <%=nomenclature[i].matiere %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="brut">
                        <%=nomenclature[i].brut %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="realisation">
                        <%=nomenclature[i].realisation %> 
                    </td>
                    <td  contenteditable='true' id="<%=i%>" class="finition">
                        <%=nomenclature[i].finition %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="traitementDeSurface">
                        <%=nomenclature[i].traitementDeSurface %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="planEdite">
                        <%=nomenclature[i].planEdite %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="fournisseur">
                        <%=nomenclature[i].fournisseur %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="refDescriptionFournisseur">
                        <%=nomenclature[i].refDescriptionFournisseur %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="prixnetUnitaireMs">
                        <%=nomenclature[i].prixnetUnitaireMs %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="remise">
                        <%=nomenclature[i].remise %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="prixNetTotal">
                        <%=nomenclature[i].PrixNetTotal %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="marge">
                        <%=nomenclature[i].marge %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="prixunitclient">
                        <%=nomenclature[i].prixunitclient %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="prixtotalclient">
                        <%=nomenclature[i].prixtotalclient %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="datedelivraisonprevue">
                        <%=nomenclature[i].datedelivraisonprevue %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="statut">
                        <%=nomenclature[i].statut %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="bonDeCommande">
                        <%=nomenclature[i].bonDeCommande %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="commentaire">
                        <%=nomenclature[i].commentaire %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="numProjet">
                        <%=nomenclature[i].numProjet %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="nomProjet">
                        <%=nomenclature[i].nomProjet %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="client">
                        <%=nomenclature[i].client %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="idFournisseur0">
                        <%=nomenclature[i].idFournisseur0 %> 
                    </td>
                    <td contenteditable='true' id="<%=i%>" class="idNomenclature" >
                        <%=nomenclature[i].idNomenclature %> 
                    </td>
            </tr>
            <% } %> 
    </table>

    <script>
        function ajoutePDF() {
            let reference = document.getElementById("reference").value;
            data = {reference};
            const options = {
                    method: 'POST',
                    headers: {
                    'Content-Type':'application/json'
                    },
                body: JSON.stringify(data)
                };
            fetch('./nomenclature/inter/ajoutPDF', options);
        }

        function myFunction() {
            // fonction filtre-recherche
            var input, filter, table, tr, td, i, txtValue;
            input = document.getElementById("myInput");
            filter = input.value.toUpperCase();
            table = document.getElementById("myTable");
            tr = table.getElementsByTagName("tr");
            a = document.getElementById("selectionRecherche").value;
            // Loop tr
            for (i = 0; i < tr.length; i++) {
                td = tr[i].getElementsByTagName("td")[a];
                if (td) {
                    txtValue = td.textContent || td.innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                    } else {
                    tr[i].style.display = "none";
                    }
                }
            }
        }

        //Pour trigger modification et envoyer avec post method
        var all = document.getElementsByTagName("td");
        for (var j=0; j<all.length;j++){
            all[j].addEventListener("input", function(e) {
                const newData = this.innerHTML;
                let stringID = 'idPiece' + this.id;
                const myID = document.getElementById(stringID).innerHTML;
                const myColumn = this.className;
                const data = {newData, myID, myColumn};
                const options = {
                    method: 'POST',
                    headers: {
                    'Content-Type':'application/json'
                    },
                body: JSON.stringify(data)
                };
                fetch('./nomenclature/inter/modification', options);
                e.stopPropagation();
            }, false);       
        }
        
        //Pour affichage ou pas des colonnes visible
        var delC =null, oTh =  null;
        document.addEventListener('DOMContentLoaded',function(){
            //reperage click
            oTable = document.getElementById('myTable');
            oTh = oTable.getElementsByTagName('th');
            for(var i = 0; i<oTh.length; i++){
                oTh[i].addEventListener('click',  supprimerColonne);
            }
        });
        
        function supprimerColonne(oEvent){
            var sClassHide = 'cel-hide',oEle = oEvent.currentTarget,
                oTable = oEle.parentNode.parentNode.parentNode,
                iIndex = oEle.cellIndex,
                oTd = oTable.querySelectorAll('td:nth-child('+(iIndex+1)+')'), 
                iNbTd = oTd.length;
            for(var i = 0; i< iNbTd; i++){
                oTd[i].classList.add(sClassHide);
            }
            oEle.classList.add(sClassHide);
            addAfficher(iIndex);
        }
        
        function names(iIndex){
            let res;
            switch(iIndex){
                case 1:
                    res = "idPiece";
                    break;
                case 2:
                    res = "denomination";
                    break;
                case 3:
                    res = "n_piece_plan";
                    break;
                case 4:
                    res = "rev";
                    break;
                case 5:
                    res = "qte";
                    break;
                case 6:
                    res = "unite";
                    break;
                case 7:
                    res = "matiere";
                    break;
                case 8:
                    res = "brut";
                    break;
                case 9:
                    res = "realisation";
                    break;
                case 10:
                    res = "finition";
                    break;
                case 11:
                    res = "traitement de surface";
                    break;
                case 12:
                    res = "plan edite";
                    break;
                case 13:
                    res = "fournisseur";
                    break;
                case 14:
                    res = "ref descript fournisseur";
                    break;
                case 15:
                    res = "prix net unitaire";
                    break;
                case 16:
                    res = "remise";
                    break;
                case 17:
                    res = "prix net total";
                    break;
                case 18:
                    res = "marge";
                    break;
                case 19:
                    res = "prix unit client";
                    break;
                case 20:
                    res = "prix total client";
                    break;
                case 21:
                    res = "denomination";
                    break;
                case 22:
                    res = "denomination";
                    break;
                default:
                    res = iIndex;
            }
            return res;
        }

        function addAfficher(iIndex){
            var oBloc = document.getElementById("reaffiche");
            let cellName = names(iIndex);
            oBloc.innerHTML += '<a href="javascript:reAfficher('+iIndex+')" id="col-'+iIndex+'">Réaffiche colonne '+cellName+'</a><br>';
        }
        
        function reAfficher(iIndex){
            document.getElementById("col-"+iIndex).remove();
            var sClassHide = 'cel-hide',
                oTable = document.getElementById("myTable"),
                oTd = oTable.querySelectorAll('td:nth-child('+(iIndex+1)+')'), 
                iNbTd = oTd.length;
            for(var i = 0; i< iNbTd; i++){
                oTd[i].classList.remove(sClassHide);
            }
            oTable.querySelector('th:nth-child('+(iIndex+1)+')').classList.remove(sClassHide);
        }
        </script>
</body>
</html>